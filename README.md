# 利用台数予測と比較分析システム

## 概要

このアプリケーションは、過去の予約データ（CSV形式）を分析し、特定の利用日における車両の利用台数を予測したり、データのクレンジングを行うためのシステムです。PyCaretライブラリを利用して複数の機械学習モデルを比較・評価し、最適なモデルを選択します。また、価格変動があった場合のシナリオに基づいた予測を行い、実績データと比較することで、価格戦略の影響を分析する機能も備えています。

アプリケーションは主に2つのモードで構成されます:
1.  **予測・比較分析:** 特定の利用日を選択し、その日の利用台数累積を予測・分析します。
2.  **データ分析・修正:** データの探索、特定予約日以降の傾向分析、および不要なデータの修正を行います。

## 主な機能

### 共通
1.  **データ読み込みと初期処理:**
    *   CSVファイルをアップロードし、データを読み込みます。
    *   日付列の型変換、リードタイム（予約日から利用日までの日数）の計算、価格差・価格比などの特徴量エンジニアリングを行います。
    *   初期のラグ特徴量（例: 30日前の利用台数累積）を計算します。

### 予測・比較分析ページ
1.  **実績データの可視化:**
    *   選択された利用日と車両クラスにおける実際の予約曲線（リードタイムに対する利用台数累積）をグラフで表示します。
    *   同期間の価格推移（トヨタ、オリックス）もグラフで表示します。
2.  **機械学習モデルの比較と選択:**
    *   ユーザーが設定ファイル (`config.yaml`) またはUIで選択した特徴量と機械学習モデルに基づき、PyCaretを用いてモデルの訓練・評価を行います。
    *   **時系列クロスバリデーション** を使用してモデルの汎化性能を評価します。
    *   RMSE（Root Mean Squared Error）等を基準に、最も性能の良いモデルを自動で選択します。
    *   各モデルのクロスバリデーション結果（平均スコア、標準偏差）および**各Foldの詳細なスコア**をテーブルで表示します。
3.  **特徴量重要度の表示:**
    *   選択された最良モデルにおいて、どの特徴量が予測に強く影響しているかを棒グラフとデータテーブルで表示します。
4.  **シナリオベースの予測:**
    *   実績データから、選択された**利用日**に対して価格（トヨタ、オリックス）が最後に変更されたリードタイムを検出します。
    *   「もし価格が最後に変更された時点から利用日まで、その最後の価格で固定されていたら」というシナリオを作成します。
    *   最良モデルを用いて、このシナリオに基づいた利用台数の予測値を計算します。（価格変動がなかった場合は実行されません。）
    *   予測実行時に、**特徴量データに欠損値(NaN)が含まれていた場合、自動的に補完（数値は平均値、カテゴリは最頻値）を行い、その詳細（どの列が、何行、どの方法で、どの値で補完されたか）をログとして表示します。また、NaNが含まれていた行の補完前・後のデータも表示します。**
    *   **予測に使用したシナリオデータはCSV形式でダウンロード可能です。**
5.  **実績 vs 予測の比較:**
    *   価格変動があった場合、実際の利用台数と上記シナリオに基づく予測値を比較するグラフとデータテーブルを表示します。
    *   比較は、価格が最後に変更されたリードタイム以降の期間に限定して表示されます。

### データ分析・修正ページ
1.  **データ探索:**
    *   データの基本情報（行数、列数）、各列のデータ型、欠損値の有無、数値・カテゴリデータの基本統計量を表示します。
    *   探索結果はMarkdown形式でダウンロード可能です。
2.  **特定予約日以降の日別合計分析:**
    *   ユーザーが選択した**予約日**より後の日付について、日ごとの利用台数の合計推移をグラフで表示します。
    *   グラフの値が最初にゼロ（またはそれ以下）になった予約日を特定し、表示します。
3.  **データ更新とラグ再計算:**
    *   上記で特定された「ゼロサム予約日」以降のデータについて、「利用台数」および「利用台数累積」を欠損値(NA)に更新する機能を提供します。（ボタンクリックで実行）
    *   データ更新後、影響を受けるラグ特徴量（例: `利用台数累積_lag30`）を自動で再計算します。
    *   更新・再計算の結果サマリー（更新行数、NaNになった行数など）を表示します。
4.  **列の削除:**
    *   UI上で不要な列を選択し、データフレームから削除する機能を提供します。
5.  **行の削除（欠損値基準）:**
    *   UI上で指定した列に欠損値(NaN)が含まれる行をデータフレームから削除する機能を提供します。削除された行のプレビューも可能です。
6.  **修正済みデータの保存:**
    *   データ更新、列削除、行削除などを行った現在のデータフレームの状態をCSVファイルとしてダウンロードする機能を提供します。

## 設定ファイル (`config.yaml`)

オプションとして、`config.yaml` ファイルをアプリケーションと同じディレクトリに置くことで、**予測・比較分析ページ**における以下のデフォルト値を設定できます。

*   `default_numeric_features`: モデル学習時にデフォルトで選択される数値特徴量のリスト。
*   `default_categorical_features`: モデル学習時にデフォルトで選択されるカテゴリ特徴量のリスト。
*   `default_models_to_compare`: デフォルトで比較・評価するPyCaretのモデルIDのリスト (例: `['xgboost', 'lightgbm']`)。

設定ファイルがない場合や、特定の設定項目がない場合は、アプリケーション内のデフォルト値（または利用可能な全ての特徴量）が使用されます。

## 必要なもの

*   Python 3.x
*   `requirements.txt` に記載されたライブラリ (`pip install -r requirements.txt` でインストール)
*   分析対象の予約データ (CSV形式)

## 実行方法

1.  ターミナルを開き、アプリケーションのディレクトリ (`app.py` がある場所) に移動します。
2.  必要なライブラリをインストールします: `pip install -r requirements.txt`
3.  Streamlitアプリケーションを実行します: `streamlit run app.py`
4.  Webブラウザで表示されたURLにアクセスします。
5.  サイドバー上部のラジオボタンで「予測・比較分析」または「データ分析・修正」を選択します。
6.  サイドバー下部からCSVファイルをアップロードします。
7.  選択したモードに応じて、サイドバーで必要な設定（利用日、予約日、モデル、特徴量など）を行い、「分析実行」や「更新」ボタンをクリックします。

## コード構成

*   `app.py`: Streamlitアプリケーションのメインファイル。ページの切り替え、セッション管理、初期データ処理を担当。
*   `utils/`: 各種処理を行う関数を格納したディレクトリ。
    *   `constants.py`: 定数定義。
    *   `data_processing.py`: データ読み込み、前処理、特徴量エンジニアリング、シナリオ作成など。
    *   `data_modification.py`: データ修正（Null化など）。
    *   `analysis.py`: 特定の分析処理（日別合計など）。
    *   `modeling.py`: PyCaretを使ったモデル学習・予測処理。
    *   `visualization.py`: Plotlyを使ったグラフ描画処理。
    *   `ui_components.py`: StreamlitのUIウィジェット（サイドバーなど）の描画処理。
    *   `page_prediction.py`: 「予測・比較分析」ページのUIとロジック。
    *   `page_analysis.py`: 「データ分析・修正」ページのUIとロジック。

## 得られる結果

*   **画面表示:**
    *   処理済みデータのプレビュー
    *   データ探索結果 (基本統計量、欠損値など)
    *   【予測ページ】 実績の予約曲線・価格推移グラフ
    *   【予測ページ】 モデル評価比較テーブル、クロスバリデーション詳細
    *   【予測ページ】 最良モデルの特徴量重要度グラフとテーブル
    *   【予測ページ】 予測時の特徴量欠損値補完ログ、補完前後のNaN行データ
    *   【予測ページ】 実績 vs 予測比較グラフとテーブル (価格変動があった場合)
    *   【分析ページ】 特定予約日以降の日別合計推移グラフ
    *   【分析ページ】 データ更新・ラグ再計算の結果サマリー
    *   【分析ページ】 削除されたNaN行のプレビュー
*   **ダウンロード:**
    *   データ探索レポート (`data_exploration_report.md`)
    *   【予測ページ】 予測に使用したシナリオデータ（CSV）
    *   【分析ページ】 修正済みデータ（CSV） 