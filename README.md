# 利用台数予測と比較分析システム

## 概要

このアプリケーションは、過去の予約データ（CSV形式）を分析し、特定の利用日における車両の利用台数を予測したり、データのクレンジングを行うためのシステムです。PyCaretライブラリを利用して複数の機械学習モデルを比較・評価し、最適なモデルを選択します。また、価格変動があった場合のシナリオに基づいた予測を行い、実績データと比較することで、価格戦略の影響を分析する機能も備えています。

アプリケーションは主に4つのモードで構成されます:
1.  **モデルトレーニング:** 学習データをもとに複数の機械学習モデルを評価・比較し、最適なモデルを選択して保存します。
2.  **予測分析:** 保存済みのモデルを使用して、特定の利用日の利用台数を予測します。
3.  **バッチ分析:** 複数日付・車両クラスの組み合わせに対して一括で予測分析を行い、集計結果を表示します。
4.  **データ分析・修正:** データの探索、特定予約日以降の傾向分析、および不要なデータの修正を行います。

## 主な機能

### 共通
1.  **データ読み込みと初期処理:**
    *   CSVファイルをアップロードし、データを読み込みます。
    *   日付列の型変換、リードタイム（予約日から利用日までの日数）の計算、価格差・価格比などの特徴量エンジニアリングを行います。
    *   初期のラグ特徴量（例: 30日前の利用台数累積）を計算します。

### モデルトレーニングページ
1.  **モデルトレーニング設定:**
    *   予測に使用する車両クラス、数値特徴量、カテゴリ特徴量、およびモデルタイプを選択します。
    *   モデルに付ける名前を入力します（保存時に使用）。
2.  **モデル比較と評価:**
    *   ユーザーが選択した特徴量と機械学習モデルに基づき、PyCaretを用いてモデルの訓練・評価を行います。
    *   **時系列クロスバリデーション** を使用してモデルの汎化性能を評価します。
    *   RMSE（Root Mean Squared Error）等を基準に、最も性能の良いモデルを自動で選択します。
    *   各モデルのクロスバリデーション結果（平均スコア、標準偏差）および**各Foldの詳細なスコア**をテーブルで表示します。
3.  **特徴量重要度の表示:**
    *   選択された最良モデルにおいて、どの特徴量が予測に強く影響しているかを棒グラフとデータテーブルで表示します。
4.  **モデルの保存:**
    *   学習済みモデル、その性能指標（メトリクス）、使用した特徴量などの情報をローカルディスク（`saved_models`ディレクトリ）に保存します。
    *   保存済みモデルの一覧の確認と、不要になったモデルの削除が可能です。

### 予測分析ページ
1.  **保存済みモデル選択:**
    *   ローカルに保存された学習済みモデルから、予測に使用するモデルをドロップダウンメニューで選択します。
    *   ドロップダウンメニュー下に**折りたたみ式の「保存済みモデル一覧」**を表示。必要に応じて展開することで、全モデルの情報（名前、タイプ、車両クラス、各種性能指標）を一覧で確認できます。
    *   選択したモデルの基本情報（名前、タイプ、作成日）や性能指標が詳細に表示されます。
2.  **実績データの可視化:**
    *   選択された利用日と車両クラスにおける実際の予約曲線（リードタイムに対する利用台数累積）をグラフで表示します。
    *   同期間の価格推移（トヨタ、オリックス）もグラフで表示します。
3. **予約曲線比較の表示オプション:**
    *   **タブインターフェース**で「価格変更後のみ」と「全期間比較」を切り替え可能です。
    *   「全期間比較」タブでは価格変更点を**緑色の縦線**でマークし、変更前後の傾向を一度に確認できます。
4.  **シナリオベースの予測:**
    *   実績データから、選択された**利用日**に対して価格（トヨタ、オリックス）が最後に変更されたリードタイムを検出します。
    *   「もし価格が最後に変更された時点から利用日まで、その最後の価格で固定されていたら」というシナリオを作成します。
    *   選択されたモデルを用いて、このシナリオに基づいた利用台数の予測値を計算します。（価格変動がなかった場合は実行されません。）
    *   予測実行時に、**特徴量データに欠損値(NaN)が含まれていた場合、自動的に補完（数値は平均値、カテゴリは最頻値）を行い、その詳細（どの列が、何行、どの方法で、どの値で補完されたか）をログとして表示します。また、NaNが含まれていた行の補完前・後のデータも表示します。**
    *   **予測に使用したシナリオデータはCSV形式でダウンロード可能です。**
5.  **実績 vs 予測の比較:**
    *   価格変動があった場合、実際の利用台数と上記シナリオに基づく予測値を比較するグラフとデータテーブルを表示します。
    *   比較は、価格が最後に変更されたリードタイム以降の期間に限定して表示されます。
6.  **売上金額ベースの比較分析:**
    *   実績と価格固定シナリオそれぞれの「利用台数×価格」に基づく売上金額を計算します。
    *   売上差額（実績売上 - 予測売上）をグラフとメトリクスで表示します。
    *   詳細なデータテーブルを表示し、CSVダウンロードも可能です。

### バッチ分析ページ
1.  **複数日付・車両クラスの一括分析:**
    *   複数の利用日と車両クラスの組み合わせに対して一括で予測分析を実行します。
    *   日付は「範囲指定」または「個別選択」、車両クラスは「すべて」または「個別選択」が可能です。
2.  **並列処理による高速化:**
    *   処理を並列化することで、多数の組み合わせに対する分析を効率的に実行します。
    *   並列処理数をスライダーで調整し、処理時間の目安を表示します。
3.  **集計結果の表示:**
    *   日付別・車両クラス別の分析結果を集計して表示します。
    *   日次売上差額、累積売上差額、価格変更点情報などを一覧できます。
4.  **売上金額影響分析:**
    *   価格変更が売上に与えた影響を「各リードタイムでの日次新規予約数×価格」の計算方法で定量的に評価します。
    *   実績売上と予測売上（価格固定シナリオ）の差額に基づく影響分析を行います。

### データ分析・修正ページ
1.  **データ探索:**
    *   データの基本情報（行数、列数）、各列のデータ型、欠損値の有無、数値・カテゴリデータの基本統計量を表示します。
    *   探索結果はMarkdown形式でダウンロード可能です。
2.  **特定予約日以降の日別合計分析:**
    *   ユーザーが選択した**予約日**より後の日付について、日ごとの利用台数の合計推移をグラフで表示します。
    *   グラフの値が最初にゼロ（またはそれ以下）になった予約日を特定し、表示します。
    *   分析用のデフォルト日付として2025-01-05が設定されています。
3.  **データ更新とラグ再計算:**
    *   上記で特定された「ゼロサム予約日」以降のデータについて、「利用台数」および「利用台数累積」を欠損値(NA)に更新する機能を提供します。（ボタンクリックで実行）
    *   データ更新後、影響を受けるラグ特徴量（例: `利用台数累積_lag30`）を自動で再計算します。
    *   更新・再計算の結果サマリー（更新行数、NaNになった行数など）を表示します。
4.  **列の削除:**
    *   UI上で不要な列を選択し、データフレームから削除する機能を提供します。
5.  **行の削除（欠損値基準）:**
    *   UI上で指定した列に欠損値(NaN)が含まれる行をデータフレームから削除する機能を提供します。削除された行のプレビューも可能です。
6.  **修正済みデータの保存:**
    *   データ更新、列削除、行削除などを行った現在のデータフレームの状態をCSVファイルとしてダウンロードする機能を提供します。

## モデルの保存と再利用

本アプリケーションでは、学習済みモデルをローカルディスクに保存し、再利用することができます。

1.  **モデルの保存:**
    *   「モデルトレーニング」ページで学習・評価したモデルは、自動的に学習済みモデルとしてローカルに保存されます。
    *   保存されるファイルは以下の3種類です：
        *   モデル本体（`.pkl`ファイル）
        *   モデルのメタデータ（`.json`ファイル）：モデル名、モデルタイプ、特徴量情報、評価指標などを含む
        *   モデル比較結果（`.csv`ファイル）：PyCaretによる各モデルの比較結果
    *   すべてのファイルは`saved_models`ディレクトリに保存されます。

2.  **モデルの選択と再利用:**
    *   「予測分析」ページでは、保存済みモデルの一覧から使用するモデルを選択できます。
    *   サイドバーの折りたたみ式「保存済みモデル一覧」で全モデルを比較できます。
    *   モデルのメタデータから、モデルの基本情報や性能指標が表示されます。
    *   特定の車両クラス専用のモデルは、その車両クラスのデータにのみ適用されます。

3.  **モデルの管理:**
    *   「モデルトレーニング」ページでは、保存済みモデルの一覧表示と削除が可能です。
    *   不要になったモデルは削除できます（関連するメタデータと比較結果も同時に削除されます）。

## 設定ファイル (`config.yaml`)

オプションとして、`config.yaml` ファイルをアプリケーションと同じディレクトリに置くことで、**モデルトレーニングページ**における以下のデフォルト値を設定できます。

*   `default_numeric_features`: モデル学習時にデフォルトで選択される数値特徴量のリスト。
*   `default_categorical_features`: モデル学習時にデフォルトで選択されるカテゴリ特徴量のリスト。
*   `default_models_to_compare`: デフォルトで比較・評価するPyCaretのモデルIDのリスト (例: `['xgboost', 'lightgbm']`)。

設定ファイルがない場合や、特定の設定項目がない場合は、アプリケーション内のデフォルト値（または利用可能な全ての特徴量）が使用されます。

## 必要なもの

*   Python 3.x
*   `requirements.txt` に記載されたライブラリ (`pip install -r requirements.txt` でインストール)
*   分析対象の予約データ (CSV形式)

## 実行方法

1.  ターミナルを開き、アプリケーションのディレクトリ (`app.py` がある場所) に移動します。
2.  必要なライブラリをインストールします: `pip install -r requirements.txt`
3.  Streamlitアプリケーションを実行します: `streamlit run app.py`
4.  Webブラウザで表示されたURLにアクセスします。
5.  サイドバー上部のラジオボタンで「モデルトレーニング」、「予測分析」、「バッチ分析」または「データ分析・修正」を選択します。
6.  サイドバー下部からCSVファイルをアップロードします。
7.  選択したモードに応じて、サイドバーで必要な設定を行い、各ページの指示に従って操作します。

## コード構成

*   `app.py`: Streamlitアプリケーションのメインファイル。ページの切り替え、セッション管理、初期データ処理を担当。
*   `utils/`: 各種処理を行う関数を格納したディレクトリ。
    *   `constants.py`: 定数定義。
    *   `data_processing.py`: データ読み込み、前処理、特徴量エンジニアリング、シナリオ作成など。
    *   `data_modification.py`: データ修正（Null化など）。
    *   `analysis.py`: 特定の分析処理（日別合計など）。
    *   `modeling.py`: PyCaretを使ったモデル学習・予測処理。
    *   `visualization.py`: Plotlyを使ったグラフ描画処理。
    *   `ui_components.py`: StreamlitのUIウィジェット（サイドバーなど）の描画処理。
    *   `model_storage.py`: モデルの保存・読み込み・管理機能。
    *   `page_model_training.py`: 「モデルトレーニング」ページのUIとロジック。
    *   `page_prediction.py`: 「予測分析」ページのUIとロジック。
    *   `page_batch_analysis.py`: 「バッチ分析」ページのUIとロジック。
    *   `page_analysis.py`: 「データ分析・修正」ページのUIとロジック。
    *   `batch_analysis.py`: バッチ処理用の関数。
*   `saved_models/`: 学習済みモデルや関連ファイルが保存されるディレクトリ（アプリ初回起動時に自動生成）。

## 得られる結果

*   **画面表示:**
    *   処理済みデータのプレビュー
    *   データ探索結果 (基本統計量、欠損値など)
    *   【モデルトレーニング】 保存済みモデル一覧
    *   【モデルトレーニング】 モデル評価比較テーブル、クロスバリデーション詳細
    *   【モデルトレーニング】 最良モデルの特徴量重要度グラフとテーブル
    *   【予測ページ】 サイドバーの折りたたみ式モデル一覧
    *   【予測ページ】 選択したモデルの情報と性能指標
    *   【予測ページ】 実績の予約曲線・価格推移グラフ（タブで全期間/価格変更後を切替）
    *   【予測ページ】 予測時の特徴量欠損値補完ログ、補完前後のNaN行データ
    *   【予測ページ】 実績 vs 予測比較グラフとテーブル (価格変動があった場合)
    *   【予測ページ】 売上金額ベースでの差額分析グラフとメトリクス
    *   【バッチページ】 複数日付・車両クラスの集計結果一覧
    *   【バッチページ】 日付別・車両クラス別の売上差額分析
    *   【分析ページ】 特定予約日以降の日別合計推移グラフ
    *   【分析ページ】 データ更新・ラグ再計算の結果サマリー
    *   【分析ページ】 削除されたNaN行のプレビュー
*   **ダウンロード:**
    *   データ探索レポート (`data_exploration_report.md`)
    *   【予測ページ】 予測に使用したシナリオデータ（CSV）
    *   【予測ページ】 売上金額分析結果テーブル（CSV）
    *   【バッチページ】 バッチ分析結果一覧（CSV）
    *   【分析ページ】 修正済みデータ（CSV）
*   **保存ファイル:**
    *   学習済みモデル（`.pkl`）
    *   モデルメタデータ（`.json`）
    *   モデル比較結果（`.csv`） 