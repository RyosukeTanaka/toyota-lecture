# 利用台数予測と比較分析システム

## 概要

このアプリケーションは、過去の予約データ（CSV形式）を分析し、特定の利用日における車両の利用台数を予測するシステムです。PyCaretライブラリを利用して複数の機械学習モデルを比較・評価し、最適なモデルを選択します。さらに、価格変動があった場合のシナリオに基づいた予測を行い、実績データと比較することで、価格戦略の影響を分析するのに役立ちます。

## 主な機能

1.  **データ読み込みと前処理:**
    *   CSVファイルをアップロードし、データを読み込みます。
    *   日付列の型変換、リードタイム（予約日から利用日までの日数）の計算、価格差・価格比などの特徴量エンジニアリングを行います。
2.  **データ探索:**
    *   データの基本情報（行数、列数）、各列のデータ型、欠損値の有無、数値・カテゴリデータの基本統計量を表示します。
    *   探索結果はMarkdown形式でダウンロード可能です。
3.  **実績データの可視化:**
    *   選択された利用日と車両クラスにおける実際の予約曲線（リードタイムに対する利用台数累積）をグラフで表示します。
    *   同期間の価格推移（トヨタ、オリックス）もグラフで表示します。
4.  **機械学習モデルの比較と選択:**
    *   ユーザーが設定ファイル (`config.yaml`) またはUIで選択した特徴量と機械学習モデルに基づき、PyCaretを用いてモデルの訓練・評価（クロスバリデーション）を行います。
    *   RMSE（Root Mean Squared Error）を基準に、最も性能の良いモデルを自動で選択します。
    *   各モデルの評価指標（MAE, MSE, RMSE, R2など）をテーブルで表示します。
5.  **特徴量重要度の表示:**
    *   選択された最良モデルにおいて、どの特徴量が予測に強く影響しているかを棒グラフとデータテーブルで表示します。
6.  **シナリオベースの予測:**
    *   実績データから価格（トヨタ、オリックス）が最後に変更されたリードタイムを検出します。
    *   「もし価格が最後に変更された時点から利用日まで、その最後の価格で固定されていたら」というシナリオを作成します。
    *   最良モデルを用いて、このシナリオに基づいた利用台数の予測値を計算します。（価格変動がなかった場合は実行されません。）
7.  **実績 vs 予測の比較:**
    *   価格変動があった場合、実際の利用台数と上記シナリオに基づく予測値を比較するグラフとデータテーブルを表示します。
    *   比較は、価格が最後に変更されたリードタイム以降の期間に限定して表示されます。

## 設定ファイル (`config.yaml`)

オプションとして、`config.yaml` ファイルをアプリケーションと同じディレクトリに置くことで、以下のデフォルト値を設定できます。

*   `default_numeric_features`: モデル学習時にデフォルトで選択される数値特徴量のリスト。
*   `default_categorical_features`: モデル学習時にデフォルトで選択されるカテゴリ特徴量のリスト。
*   `default_models_to_compare`: デフォルトで比較・評価するPyCaretのモデルIDのリスト (例: `['xgboost', 'lightgbm']`)。

設定ファイルがない場合や、特定の設定項目がない場合は、アプリケーション内のデフォルト値（または利用可能な全ての特徴量）が使用されます。

## 必要なもの

*   Python 3.x
*   `requirements.txt` に記載されたライブラリ (`pip install -r requirements.txt` でインストール)
*   分析対象の予約データ (CSV形式)

## 実行方法

1.  ターミナルを開き、アプリケーションのディレクトリに移動します。
2.  必要なライブラリをインストールします: `pip install -r requirements.txt`
3.  Streamlitアプリケーションを実行します: `streamlit run app.py`
4.  Webブラウザで表示されたURLにアクセスします。
5.  サイドバーからCSVファイルをアップロードし、分析したい車両クラスと利用日、モデル設定を選択して「分析・予測実行」ボタンをクリックします。

## 得られる結果

*   **画面表示:**
    *   処理済みデータのプレビュー
    *   データ探索結果 (基本統計量、欠損値など)
    *   実績の予約曲線グラフ
    *   実績の価格推移グラフ
    *   モデル評価比較テーブル
    *   最良モデルの特徴量重要度グラフとテーブル
    *   実績 vs 予測比較グラフとテーブル (価格変動があった場合)
*   **ダウンロード:**
    *   データ探索レポート (`data_exploration_report.md`)
    *   [モデル学習に使用したデータのサンプル (選択された特徴量 + 目的変数)](merged_data_with_cumulative_False_164_1.csv) 