# Streamlit + PyCaret 利用台数予測システム導入プラン

## 1. 目的

既存のStreamlitアプリケーション (`app.py`) を拡張し、アップロードされたCSVデータを用いて「利用台数」を予測する機械学習システムを構築する。ユーザーは以下の操作を行えるようにする。

*   予測対象のCSVファイルをアップロードする。
*   予測に使用する特徴量をデータから選択する。
*   評価したい複数の機械学習モデルを選択する。
*   選択されたモデルの性能評価（RMSE, MAE, R2など）を比較検討する。

## 2. 環境構築

開発に必要なライブラリをインストールする。

1.  **`requirements.txt` の作成または更新**:
    *   `streamlit`: UI構築用。
    *   `pandas`: データ操作用。
    *   `pycaret[full]`: 機械学習モデルの構築・評価用（`[full]`で多くの依存関係を含む）。
    ```txt
    streamlit
    pandas
    pycaret[full]
    ```
2.  **ライブラリのインストール**:
    ```powershell
    pip install -r requirements.txt
    ```

## 3. `app.py` の改修

既存の `app.py` に以下の機能を追加・変更する。

1.  **ライブラリのインポート**:
    ```python
    import streamlit as st
    import pandas as pd
    import os
    from pycaret.regression import setup, compare_models, pull, save_model # 回帰タスク用
    ```
2.  **UIの拡張**:
    *   既存のファイルアップローダーは維持する。
    *   データ読み込み後、以下のUI要素を追加する。
        *   **ターゲット変数の選択**: デフォルトで '利用台数' を選択するセレクトボックス（将来的には他の列も選択可能にする）。
        *   **特徴量の選択**: データフレームのカラム一覧から、ユーザーが複数選択できるマルチセレクトボックス。ターゲット変数は除外する。
        *   **評価モデルの選択**: PyCaretがサポートする回帰モデルのリスト（例: 'lr', 'ridge', 'lasso', 'knn', 'dt', 'rf', 'et', 'lightgbm', 'xgboost' など）から、ユーザーが複数選択できるマルチセレクトボックス。
        *   **実行ボタン**: 上記の設定でモデル比較を開始するためのボタン。
3.  **PyCaret処理の実装**:
    *   「実行ボタン」が押されたら、以下の処理を実行する。
        *   `st.spinner` を表示して処理中であることをユーザーに示す。
        *   選択されたターゲット変数と特徴量を用いて、PyCaretの `setup()` 関数を実行する。
            *   `data`: アップロードされたDataFrame。
            *   `target`: 選択されたターゲット変数。
            *   `numeric_features`, `categorical_features`: 選択された特徴量を適切に指定（PyCaretが自動判別することも可能だが、明示的に指定する方が確実な場合がある）。
            *   `session_id`: 再現性のための乱数シード。
            *   `silent=True`: Streamlit環境での冗長な出力を抑制。
            *   `html=False`: Streamlit環境ではHTML出力をFalseにする。
        *   `setup()` が成功したら、選択されたモデルリストを `include` 引数に指定して `compare_models()` 関数を実行する。
            *   `include`: 選択されたモデルIDのリスト。
            *   `fold`: クロスバリデーションの फोल्ड 数 (例: 5)。
            *   `sort`: 結果をソートする評価指標 (例: 'RMSE')。
        *   `compare_models()` の結果を取得するために `pull()` 関数を使用し、結果のDataFrameを `st.dataframe()` で表示する。
        *   処理完了後、スピナーを非表示にする。
4.  **エラーハンドリング**:
    *   `setup()`, `compare_models()` の実行中に発生する可能性のある例外（例: データ形式の問題、選択された特徴量/モデルの問題）を `try-except` ブロックで捕捉し、`st.error()` でユーザーに分かりやすいエラーメッセージを表示する。

## 4. テスト

以下の点を確認する。

*   CSVファイルのアップロードと表示が正しく行えるか。
*   ターゲット変数、特徴量、モデルの選択UIが正しく表示され、選択できるか。
*   「実行ボタン」を押すと、PyCaretの処理が開始され、スピナーが表示されるか。
*   選択した設定で `compare_models` が実行され、結果の評価指標テーブルが表示されるか。
*   不正なデータや設定（例: 特徴量が選択されていない、数値でない列をターゲットに選ぶなど）の場合に、適切なエラーメッセージが表示されるか。

## 5. (任意) 将来的な拡張

*   **モデルのチューニング**: `tune_model()` を使って選択した最良モデルのハイパーパラメータチューニングを行う機能。
*   **予測**: `predict_model()` を使って新しいデータに対する予測を行う機能。
*   **モデルの保存/読み込み**: `save_model()`, `load_model()` を使って学習済みモデルを保存・再利用する機能。
*   **可視化**: `plot_model()` を使ってモデルの様々な側面（残差プロット、特徴量重要度など）を可視化する機能。

---

このプランに基づき、`app.py` の改修を進めます。 