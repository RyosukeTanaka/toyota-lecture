# Streamlit + PyCaret 利用台数予測と比較分析システム導入プラン

## 1. 目的

既存のStreamlitアプリケーション (`app.py`) を拡張し、アップロードされたCSVデータを用いて以下の分析・予測を行うシステムを構築する。

*   **データ探索**: 基本的な統計量や欠損値を確認する（既存機能）。
*   **価格比較分析**: トヨタとオリックスの価格 (`価格_トヨタ`, `価格_オリックス`) の関係性が「利用台数累積」に与える影響を分析する。特に、価格差が開いた場合の予約傾向を確認する。
*   **特定利用日の予約曲線分析**:
    *   ユーザーが特定の「利用日」を選択できるようにする。
    *   選択された利用日について、リードタイム（予約日から利用日までの日数）に対する「利用台数累積」の推移（予約曲線）を可視化する。
*   **モデルベースの予測と比較**:
    *   アップロードされたデータを用いて、PyCaretで「利用台数累積」を予測する回帰モデルを構築・比較する。
    *   選択した利用日において、「もし価格変動がなかったら（例：特定の価格で固定されていたら）」というシナリオに基づき、構築したモデルで「利用台数累積」を予測する。
    *   実際の予約曲線と、価格変動がなかった場合の予測曲線を並べて表示し、価格変動の影響を視覚的に比較する。

ユーザーは以下の操作を行えるようにする。

*   予測対象のCSVファイルをアップロードする。
*   分析したい「利用日」を選択する。
*   予測に使用する特徴量をデータから選択する。
*   評価したい複数の機械学習モデルを選択する。
*   選択されたモデルの性能評価（RMSE, MAE, R2など）を比較検討する。
*   実際の予約曲線と、価格変動がない場合の予測曲線を比較する。

## 2. 環境構築

開発に必要なライブラリをインストールする。

1.  **`requirements.txt` の作成または更新**:
    *   `streamlit`: UI構築用。
    *   `pandas`: データ操作用。
    *   `pycaret[full]`: 機械学習モデルの構築・評価用。
    *   `plotly` または `matplotlib`: グラフ描画用（Streamlitとの連携が良いplotlyを推奨）。
    ```txt
    streamlit
    pandas
    pycaret[full]
    plotly # 追加
    ```
2.  **ライブラリのインストール**:
    ```powershell
    pip install -r requirements.txt
    ```

## 3. `app.py` の改修

既存の `app.py` に以下の機能を追加・変更する。

1.  **ライブラリのインポート**:
    ```python
    import streamlit as st
    import pandas as pd
    import os
    from pycaret.regression import setup, compare_models, pull, save_model, predict_model, load_model # predict_model, load_model を追加
    import plotly.express as px # plotly をインポート
    # import matplotlib.pyplot as plt # 必要に応じて
    ```
2.  **データ前処理**:
    *   CSV読み込み後、日付関連の列（`利用日`, `予約日`など）を `datetime` 型に変換する。
    *   **価格差特徴量の計算**: `価格_トヨタ` と `価格_オリックス` の差や比率などの新しい特徴量を作成する（例: `価格差 = 価格_トヨタ - 価格_オリックス`, `価格比 = 価格_トヨタ / 価格_オリックス`）。分析目的に応じて適切な計算を行う。
3.  **UIの拡張**:
    *   既存のファイルアップローダーは維持する。
    *   データ読み込み後、データ探索セクション（Expander内）の後に以下のUI要素を追加する。
        *   **利用日選択**: データ内のユニークな `利用日` をリスト表示し、ユーザーが分析対象の日付を選択できるセレクトボックス。
        *   （PyCaret設定セクション内）
            *   **ターゲット変数の選択**: デフォルトで '利用台数累積' を選択するセレクトボックス。
            *   **特徴量の選択**: データフレームのカラム一覧（生成した価格差特徴量も含む）から、ユーザーが複数選択できるマルチセレクトボックス。ターゲット変数と日付関連の列は除外する。
            *   **評価モデルの選択**: PyCaretがサポートする回帰モデルのリストから、ユーザーが複数選択できるマルチセレクトボックス。
            *   **モデル比較実行ボタン**: 上記の設定でモデル比較を開始するためのボタン。
4.  **分析・可視化機能の実装**:
    *   **利用日選択後の処理**:
        *   選択された `利用日` のデータのみを抽出する。
        *   **予約曲線の表示**: 抽出したデータで、`リードタイム` (利用日 - 予約日 or 既存のリードタイム列) をx軸、`利用台数累積` をy軸とする折れ線グラフ (`plotly.express.line` など) を表示する。
        *   **価格推移の表示 (任意)**: 同じグラフまたは別のグラフで、リードタイムに対する `価格_トヨタ`, `価格_オリックス` の推移も表示すると比較しやすい。
5.  **PyCaret処理と予測の実装**:
    *   「モデル比較実行ボタン」が押されたら、以下の処理を実行する。
        *   `st.spinner` を表示。
        *   選択されたターゲット変数と特徴量を用いて、PyCaretの `setup()` 関数を実行する（全データまたは選択された利用日のデータで行うか検討）。
        *   `setup()` が成功したら、`compare_models()` を実行し、結果を表示。`pull()` で結果を取得。
        *   **最良モデルの選択と保存**: `compare_models` の結果から最良モデル（例: RMSE最小）を特定し、`save_model()` で一時的に保存する（またはメモリ上に保持）。
        *   **予測用データの作成**:
            *   選択された `利用日` のデータを準備する。
            *   **「価格変動なし」シナリオ**: その利用日において、価格が変動しなかったと仮定した場合のデータを作成する。例えば、分析期間中の平均価格や、特定時点の価格（例: 予約開始時点）で `価格_トヨタ`, `価格_オリックス` を上書きする。価格差特徴量も再計算する。
        *   **予測の実行**: `load_model()` (保存した場合) または保持しているモデルオブジェクトと `predict_model()` を使用し、「価格変動なし」シナリオのデータに対する `利用台数累積` を予測する。予測結果は `prediction_label` 列として追加される。
        *   **予測結果の可視化**:
            *   既存の予約曲線グラフに、予測結果（リードタイム vs 予測された利用台数累積）を別の線で重ねて表示する。
            *   `plotly` を使用し、凡例で実際の曲線と予測曲線を区別できるようにする。
        *   処理完了後、スピナーを非表示にする。
6.  **エラーハンドリング**:
    *   `setup()`, `compare_models()`, `predict_model()` などの実行中に発生する可能性のある例外を捕捉し、`st.error()` でメッセージを表示する。特に、利用日選択、特徴量選択、データ型に関するエラーを考慮する。

## 4. テスト

以下の点を確認する。

*   CSVファイルのアップロードと基本的なデータ探索が正しく行えるか。
*   利用日選択のセレクトボックスが正しく表示され、日付を選択できるか。
*   利用日を選択すると、その日のデータに基づいた予約曲線（および価格推移）グラフが表示されるか。
*   ターゲット変数、特徴量（価格差特徴量含む）、モデルの選択UIが正しく機能するか。
*   「モデル比較実行ボタン」を押すと、PyCaretの処理が開始され、評価指標テーブルが表示されるか。
*   最良モデルによる予測が実行され、「価格変動なし」シナリオの予測値が計算されるか。
*   実際の予約曲線と予測された予約曲線が同じグラフ上に比較表示されるか。
*   不正なデータや設定（例: 利用日が選択されていない、特徴量が不適切など）の場合に、適切なエラーメッセージが表示されるか。

## 5. (任意) 将来的な拡張

*   **モデルのチューニング**: `tune_model()` 機能の追加。
*   **シナリオの多様化**: 「価格変動なし」以外のシナリオ（例: 特定の割引キャンペーンがあった場合など）での予測機能。
*   **特徴量重要度の表示**: `plot_model(model, plot='feature')` などで、どの特徴量が予測に寄与しているかを表示する。
*   **モデル永続化**: `save_model` で保存したモデルを、次回以降の起動時に `load_model` で読み込む機能（ファイルパス管理が必要）。

---

この更新されたプランに基づき、`app.py` の改修を進めます。 